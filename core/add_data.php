<script>/*<![CDATA[*/
<?php
session_start();
require'db.php';
require'zebra_image.php';
require'sanitise.php';
if((!empty($_SERVER['HTTPS'])&&$_SERVER['HTTPS']!=='off')||$_SERVER['SERVER_PORT']==443)define('PROTOCOL','https://');else define('PROTOCOL','http://');
define('SESSIONID',session_id());
define('DS',DIRECTORY_SEPARATOR);
$config=$db->query("SELECT * FROM config WHERE id=1")->fetch(PDO::FETCH_ASSOC);
define('THEME','..'.DS.'layout'.DS.$config['theme']);
define('URL',PROTOCOL.$_SERVER['HTTP_HOST'].$settings['system']['url'].'/');
define('UNICODE','UTF-8');
function svg($svg,$size=null,$color=null){
	echo'<i class="libre';
	if($size!=null)echo' libre-'.$size;
	if($color!=null)echo' libre-'.$color;
	echo'">';
	include'svg/libre-'.$svg.'.svg';
	echo'</i>';
}
$theme=parse_ini_file(THEME.DS.'theme.ini',true);
$act=isset($_POST['act'])?filter_input(INPUT_POST,'act',FILTER_SANITIZE_STRING):filter_input(INPUT_GET,'act',FILTER_SANITIZE_STRING);
if($act!=''){
  $uid=isset($_SESSION['uid'])?(int)$_SESSION['uid']:0;
  $ip=$_SERVER['REMOTE_ADDR'];
  $error=0;
  $ti=time();
  switch($act){
		case'add_reward':
			$code=filter_input(INPUT_POST,'code',FILTER_SANITIZE_STRING);
			$title=filter_input(INPUT_POST,'title',FILTER_SANITIZE_STRING);
			$method=filter_input(INPUT_POST,'method',FILTER_SANITIZE_NUMBER_INT);
			$value=filter_input(INPUT_POST,'value',FILTER_SANITIZE_NUMBER_INT);
			$quantity=filter_input(INPUT_POST,'quantity',FILTER_SANITIZE_NUMBER_INT);
			$tis=filter_input(INPUT_POST,'tis',FILTER_SANITIZE_STRING);
			$tie=filter_input(INPUT_POST,'tie',FILTER_SANITIZE_STRING);
			if($tis!='')$tis=strtotime($tis);else$tis=0;
			if($tie!='')$tie=strtotime($tie);else$tie=0;
			$q=$db->prepare("INSERT INTO rewards (code,title,method,value,quantity,tis,tie,ti) VALUES (:code,:title,:method,:value,:quantity,:tis,:tie,:ti)");
			$q->execute(array(':code'=>$code,':title'=>$title,':method'=>$method,':value'=>$value,':quantity'=>$quantity,':tis'=>$tis,':tie'=>$tie,':ti'=>$ti));
			$id=$db->lastInsertId();
			$e=$db->errorInfo();
			if(is_null($e[2])){?>
	window.top.window.$('#rewards').append('<tr id="l_<?php echo$id;?>"><td class="col-xs-1 text-center"><?php echo$code;?></td><td class="col-xs-5 text-center"><?php echo$title;?></td><td class="text-center"><?php if($method==0)echo'% Off';else echo'$ Off';?></td><td class="col-xs-1 text-center"><?php echo$value;?>&nbsp;</td><td class="col-xs-1 text-center"><?php echo$quantity;?>&nbsp;</td><td class="col-xs-1 text-center"><small><?php if($tis!=0){echo date($config['dateFormat'],$tis);}?></small></td><td class="col-xs-1 text-center"><small><?php if($tie!=0){echo date($config['dateFormat'],$tie);}?></small></td><td><form target="sp" action="core/purge.php"><input type="hidden" name="id" value="<?php echo$id;?>"><input type="hidden" name="t" value="rewards"><button class="btn btn-default trash"><?php svg('trash');?></button></form></td></tr>');
<?php	}else{?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'There was an issue adding the Reward'}}).show();
<?php }
			break;
    case'add_dashrss':
      $url=filter_input(INPUT_POST,'url',FILTER_SANITIZE_URL);
      if(filter_var($url,FILTER_VALIDATE_URL)){
        $q=$db->prepare("INSERT INTO choices (uid,contentType,url,ti) VALUES (:uid,'dashrss',:url,'0')");
        $q->execute(array(':uid'=>$uid,':url'=>$url));
        $id=$db->lastInsertId();
        $e=$db->errorInfo();
        if(is_null($e[2])){?>
  window.top.window.$('#rss').append('<div id="l_<?php echo$id;?>" class="form-group"><div class="input-group col-xs-12"><div class="input-group-addon">URL</div><form target="sp" method="post" action="core/update.php"><input type="hidden" name="t" value="choices"><input type="hidden" name="c" value="url"><input type="text"class="form-control" name="da" value="<?php echo$url;?>" placeholder="Enter a URL..."></form><div class="input-group-btn"><form target="sp" action="core/purge.php"><input type="hidden" name="id" value="<?php echo$id;?>"><input type="hidden" name="t" value="choices"><button class="btn btn-default trash"><?php svg('trash');?></button></form></div></div></div>');
<?php   }else{?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'There was an issue adding the RSS URL'}}).show();
<?php   }
      }
      break;
    case'add_social':
      $user=filter_input(INPUT_POST,'user',FILTER_SANITIZE_NUMBER_INT);
      $icon=filter_input(INPUT_POST,'icon',FILTER_SANITIZE_STRING);
      $url=filter_input(INPUT_POST,'url',FILTER_SANITIZE_URL);
      if(filter_var($url,FILTER_VALIDATE_URL)){
        if($icon=='none'||$url==''){?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'Data not Entirely Entered'}}).show();
<?php   }else{
          $user=kses($user,array());
          $url=kses($url,array());
          $q=$db->prepare("INSERT INTO choices (uid,contentType,icon,url) VALUES (:uid,'social',:icon,:url)");
          $q->execute(array(':uid'=>$user,':icon'=>$icon,':url'=>$url));
          $id=$db->lastInsertId();
          $e=$db->errorInfo();
          if(is_null($e[2])){?>
  window.top.window.$('#social').append('<div id="l_<?php echo$id;?>" class="form-group"><div class="input-group col-xs-12"><div class="input-group-addon"><span class="libre-social"><?php svg('social-'.$icon);?></span></div><form target="sp" method="post" action="core/update.php"><input type="hidden" name="t" value="social"><input type="hidden" name="c" value="url"><input type="text"class="form-control" name="da" value="<?php echo$url;?>" placeholder="Enter a URL..."></form><div class="input-group-btn"><form target="sp" action="core/purge.php"><input type="hidden" name="id" value="<?php echo$id;?>"><input type="hidden" name="t" value="choices"><button class="btn btn-default trash"><?php svg('trash');?></button></form></div></div></div>');
<?php     }else{?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'There was an issue adding the Social Networking Link'}}).show();
<?php     }
      	}
      }else{?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'The URL entered is not valid'}}).show();
<?php }
      break;
		case'add_option':
      $rid=filter_input(INPUT_POST,'rid',FILTER_SANITIZE_NUMBER_INT);
      $ttl=filter_input(INPUT_POST,'ttl',FILTER_SANITIZE_STRING);
			$qty=filter_input(INPUT_POST,'qty',FILTER_SANITIZE_NUMBER_INT);
      if($ttl==''){?>
	window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'Data not Entirely Entered'}}).show();
<?php }else{
				$ttl=kses($ttl,array());
        $q=$db->prepare("INSERT INTO choices (uid,rid,contentType,title,ti) VALUES (:uid,:rid,'option',:title,:ti)");
        $q->execute(array(':uid'=>$uid,':rid'=>$rid,':title'=>$ttl,':ti'=>$qty));
        $id=$db->lastInsertId();
        $e=$db->errorInfo();
        if(is_null($e[2])){?>
	window.top.window.$('#itemoptions').append('<div id="l_<?php echo$id;?>" class="form-group"><div class="input-group col-xs-12"><span class="input-group-addon">Option</span><form target="sp" method="post"><input type="hidden" name="id" value="<?php echo$id;?>"><input type="hidden" name="t" value="choices"><input type="hidden" name="c" value="title"><input type="text" class="form-control" name="da" value="<?php echo$ttl;?>" placeholder="Enter an Option Title..."></form><span class="input-group-addon">Quantity</span><form target="sp" method="post"><input type="hidden" name="id" value="<?php echo$id;?>"><input type="hidden" name="t" value="choices"><input type="hidden" name="c" value="ti"><input type="text" class="form-control" name="da" value="<?php echo$qty;?>" placeholder="Quantity"></form><div class="input-group-btn"><form target="sp" action="core/purge.php"><input type="hidden" name="id" value="<?php echo$id;?>"><input type="hidden" name="t" value="choices"><button class="btn btn-default trash"><?php svg('trash');?></button></form></div></div></div>');
<?php   }else{?>
	window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'There was an issue adding the Social Networking Link'}}).show();
<?php   }
      }
      break;
    case'add_subject':
      $sub=filter_input(INPUT_POST,'sub',FILTER_SANITIZE_STRING);
      $eml=filter_input(INPUT_POST,'eml',FILTER_SANITIZE_STRING);
      if($sub==''){?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'Data not Entirely Entered'}}).show();
<?php }else{
        $sub=kses($sub,array());
        $eml=kses($eml,array());
        $q=$db->prepare("INSERT INTO choices (contentType,title,url) VALUES ('subject',:title,:url)");
        $q->execute(array(':title'=>$sub,':url'=>$eml));
        $id=$db->lastInsertId();
        $e=$db->errorInfo();
        if(is_null($e[2])){?>
  window.top.window.$('#subjects').append('<div id="l_<?php echo$id;?>" class="form-group"><div class="input-group col-xs-12"><div class="input-group-addon">Subject</div><form target="sp" method="post"><input type="hidden" name="id" value="<?php echo$id;?>"><input type="hidden" name="t" value="choices"><input type="hidden" name="c" value="title"><input type="text" class="form-control" name="da" value="<?php echo$sub;?>" placeholder="Enter a Subject..."></form><div class="input-group-addon">Email</div><form target="sp" method="post"><input type="hidden" name="id" value="<?php echo$id;?>"><input type="hidden" name="t" value="choices"><input type="hidden" name="c" value="url"><input type="text" class="form-control" name="da" value="<?php echo$eml;?>" placeholder="Enter an Email..."></form><div class="input-group-btn"><form target="sp" action="core/purge.php"><input type="hidden" name="id" value="<?php echo$id;?>"><input type="hidden" name="t" value="choices"><button class="btn btn-default trash"><?php svg('trash');?></button></form></div></div></div>');
<?php   }else{?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'There was an issue adding the Social Networking Link'}}).show();
<?php   }
      }
      break;
    case'make_client':
      $id=filter_input(INPUT_GET,'id',FILTER_SANITIZE_NUMBER_INT);
      $q=$db->prepare("SELECT name,email,phone FROM messages WHERE id=:id");
      $q->execute(array(':id'=>$id));
      $r=$q->fetch(PDO::FETCH_ASSOC);
      $q=$db->prepare("INSERT INTO login (name,email,phone,ti) VALUES (:name,:email,:phone,:ti)");
      $q->execute(array(':name'=>$r[name],':email'=>$r['email'],':phone'=>$r['phone'],':ti'=>$ti));
      $e=$db->errorInfo();
      if(is_null($e[2])){?>
  window.top.window.$('.notifications').notify({type:'success',icon:'',message:{text:'Contact added as Client'}}).show();
<?php }else{?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'There was an issue Adding new Client'}}).show();
<?php }
      break;
    case'add_comment':
      $rid=filter_input(INPUT_POST,'rid',FILTER_SANITIZE_NUMBER_INT);
      $email=filter_input(INPUT_POST,'email',FILTER_SANITIZE_EMAIL);
      if(filter_var($email,FILTER_VALIDATE_EMAIL)){
        $q=$db->prepare("SELECT * FROM login WHERE email=:email");
        $q->execute(array(':email'=>$email));
        $c=$q->fetch(PDO::FETCH_ASSOC);
        if($c['id']!=0)$cid=$c['id'];else$cid=0;
        $name=filter_input(INPUT_POST,'name',FILTER_SANITIZE_STRING);
        $name=kses($name,array());
        $contentType=filter_input(INPUT_POST,'contentType',FILTER_SANITIZE_STRING);
        $da=filter_input(INPUT_POST,'da',FILTER_SANITIZE_STRING);
        $da=kses($da,array());
        $status='unapproved';
        $q=$db->prepare("INSERT INTO comments (contentType,rid,uid,cid,ip,name,email,notes,status,ti) VALUES (:contentType,:rid,:uid,:cid,:ip,:name,:email,:notes,:status,:ti)");
        $q->execute(array(':contentType'=>$contentType,':rid'=>$rid,':uid'=>$uid,':cid'=>$cid,':ip'=>$ip,':name'=>$name,':email'=>$email,':notes'=>$da,':status'=>$status,':ti'=>$ti));
        $id=$db->lastInsertId();
        $e=$db->errorInfo();
        if(is_null($e[2])){
          if($c['avatar']!=''&&file_exists('..'.DS.'media'.DS.$c['avatar']))
            $avatar='media'.DS.'avatar'.DS.$c['avatar'];
          elseif($c['gravatar']!=''){
            if(stristr($c['gravatar'],'@'))
              $avatar='http://gravatar.com/avatar/'.md5($c['gravatar']);
            elseif(stristr($c['gravatar'],'gravatar.com/avatar/'))
              $avatar=$c['gravatar'];
            else
              $avatar='core'.DS.'images'.DS.'noavatar.jpg';
          }else
            $avatar='core'.DS.'images'.DS.'noavatar.jpg';
            $html='<div id="l_'.$id.'" class="media bg-danger"><div class="media-object pull-left"><img class="commentavatar img-thumbnail" alt="User" src="'.$avatar.'"></div><div class="media-body"><h4 class="media-heading">Name</h4>'.$da.'</div><hr></div>';?>
  window.top.window.$('.notifications').notify({type:'success',icon:'',message:{text:'New comment Added, Awaiting Approval'}}).show();
  window.top.window.$('#comments').append('<?php echo$html;?>');
<?php   }else{?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'There was an issue adding your Comment'}}).show();
<?php   }
      }else{?>
  window.top.window.$('.notifications').notify({type:'danger',icon:'',message:{text:'The Email entered is not valid'}}).show();
<?php }
      break;
    case'add_avatar':
		case'add_tstavatar':
      $id=filter_input(INPUT_POST,'id',FILTER_SANITIZE_NUMBER_INT);
      $tbl=filter_input(INPUT_POST,'t',FILTER_SANITIZE_STRING);
      $tbl=kses($tbl,array());
      $col=filter_input(INPUT_POST,'c',FILTER_SANITIZE_STRING);
      $col=kses($col,array());
      $exif='none';
      $fu=$_FILES['fu'];
      if(isset($_FILES['fu'])){
        $ft=$_FILES['fu']['type'];
        if($ft=="image/jpeg"||$ft=="image/pjpeg"||$ft=="image/png"||$ft=="image/gif"){
          $tp="../media/".basename($_FILES['fu']['name']);
          if(move_uploaded_file($_FILES['fu']['tmp_name'],$tp)){
            if($ft=="image/jpeg"||$ft=="image/pjpeg")$fn=$col.'_'.$id.'.jpg';
            if($ft=="image/png")$fn=$col.'_'.$id.'.png';
            if($ft=="image/gif")$fn=$col.'_'.$id.'.gif';
						if($act=='add_tstavatar'){
							$fn='tst'.$fn;
							$q=$db->prepare("UPDATE content SET file=:avatar WHERE id=:id");
							$q->execute(array(':avatar'=>'avatar'.$fn,':id'=>$id));
						}else{
            	$q=$db->prepare("UPDATE login SET avatar=:avatar WHERE id=:id");
            	$q->execute(array(':avatar'=>'avatar'.$fn,':id'=>$id));
						}
            $image=new Zebra_image();
            $image->source_path=$tp;
            $image->target_path='..'.DS.'media'.DS.'avatar'.DS.'avatar'.$fn;
            $image->resize(150,150,ZEBRA_IMAGE_CROP_CENTER);
            rename($tp,'..'.DS.'media'.DS.'avatar'.DS.'avatar'.$fn);
						if($act=='add_tstavatar'){?>
	window.top.window.$('#tstavatar').attr('src','media/avatar/avatar<?php echo$fn.'?'.time();?>');
	window.top.window.$('#block').css({'display':'none'});
<?php 			}else{?>
  window.top.window.$('#avatar').attr('src','media/avatar/avatar<?php echo$fn.'?'.time();?>');
  window.top.window.$('#menu_avatar').attr('src','media/avatar/avatar<?php echo$fn.'?'.time();?>');
	window.top.window.$('#block').css({'display':'none'});
<?php 			}
					}
        }
      }?>
  window.top.window.$('#block').css("display","none");
<?php break;
    case'add_orderitem':
      $oid=filter_input(INPUT_GET,'oid',FILTER_SANITIZE_NUMBER_INT);
      $iid=filter_input(INPUT_GET,'iid',FILTER_SANITIZE_NUMBER_INT);
      if($iid!=0){
        $q=$db->prepare("SELECT title,cost FROM content WHERE id=:id");
        $q->execute(array(':id'=>$iid));
        $r=$q->fetch(PDO::FETCH_ASSOC);
				if($r['cost']==''||!is_numeric($r['cost']))$r['cost']=0;
      }else$r=array('title'=>'','cost'=>0);
      $q=$db->prepare("INSERT INTO orderitems (oid,iid,title,quantity,cost,ti) VALUES (:oid,:iid,:title,'1',:cost,:ti)");
      $q->execute(array(':oid'=>$oid,':iid'=>$iid,':title'=>$r['title'],':cost'=>$r['cost'],':ti'=>time()));
      $total=0;
      $html='';
      $q=$db->prepare("SELECT * FROM orderitems WHERE oid=:oid ORDER BY ti ASC,title ASC");
      $q->execute(array(':oid'=>$oid));?>
  window.top.window.$('#updateorder').html('<?php while($oi=$q->fetch(PDO::FETCH_ASSOC)){$s=$db->prepare("SELECT * FROM content WHERE id=:id");$s->execute(array(':id'=>$oi['iid']));$i=$s->fetch(PDO::FETCH_ASSOC);echo'<tr><td class="text-left">'.$i['code'].'<div class="visible-xs">'.$i['title'].'</div></td><td class="text-left hidden-xs">'.$i['title'].'</td><td class="col-md-1 text-center">';if($oi['iid']!=0){echo'<form target="sp" action="core/update.php"><input type="hidden" name="id" value="'.$oi['id'].'"><input type="hidden" name="t" value="orderitems"><input type="hidden" name="c" value="quantity"><input class="form-control text-center" name="da" value="'.$oi['quantity'].'"></form>';}echo'</td><td class="col-md-1 text-right">';if($oi['iid']!=0){echo'<form target="sp" action="core/update.php"><input type="hidden" name="id" value="'.$oi['id'].'"><input type="hidden" name="t" value="orderitems"><input type="hidden" name="c" value="cost"><input class="form-control text-center" name="da" value="'.$oi['cost'].'"></form>';}echo'</td><td class="text-right">';if($oi['iid']!=0)echo $oi['cost']*$oi['quantity'];echo'</td><td class="text-right"><form target="sp" action="core/update.php"><input type="hidden" name="id" value="'.$oi['id'].'"><input type="hidden" name="t" value="orderitems"><input type="hidden" name="c" value="quantity"><input type="hidden" name="da" value="0"><button class="btn btn-default trash">';svg('trash');echo'</button></form></td></tr>';$total=$total+($oi['cost']*$oi['quantity']);}echo'<tr><td colspan="3">&nbsp;</td><td class="text-right"><strong>Total</strong></td><td class="text-right"><strong>'.$total.'</strong></td><td></td></tr>';?>');
<?php break;
  }
}?>
/*]]>*/</script>
